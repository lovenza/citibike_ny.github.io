---
title: "EDA"
author: "Zihan Zhou"
date: "2025-11-25"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    theme: flatly
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Library key packages and load data. 

```{r}
library(tidyverse)
library(lubridate)
library(ggplot2)
library(gridExtra)
library(tsibble)
library(feasts)
library(patchwork)
library(scales)
library(knitr)
library(broom)
library(forecast)

bike <- read_csv("data/final_bike_weather_categorized.csv")

glimpse(bike)
```

# 1. Overview 概览，变量类型归类

The dataset contains **stratified sampled Citi Bike trips from September 2025**, enriched with **weather categories**.  
Each row represents **a single bike ride** with detailed trip-level information including:

- Ride ID  
- Bike type (electric vs. classic)  
- Start/end time and station  
- Rider type (member vs. casual)  
- Ride duration (hours), distance (km), bearing  
- Weather on the ride date (tmax, tmin, prcp, temperature category, rain category)  
- Weekend/weekday indicator  

This allows us to analyze:

- Time-of-day and weekday/weekend behavior  
- Member vs. casual behavior  
- Weather effects  
- Time-series trends across the month  

In this part, we perform exploratory data analysis (EDA) and visualization for Citi Bike trips in September 2025 focusing on temporal patterns and weather influences. 

```{r}
if ("datetime_start_obj" %in% names(bike) && !all(is.na(bike$datetime_start_obj))) {
  bike <- bike %>%
  mutate(datetime_start = ymd_hms(datetime_start_obj, quiet = TRUE))
} else {
  bike <- bike %>% mutate(datetime_start = ymd_hms(started_at, quiet = TRUE))
}

bike <- bike %>%
  mutate(
  date = as.Date(datetime_start),
  hour = hour(datetime_start),
  wday = wday(datetime_start, label = TRUE, week_start = 1),
  weekday_weekend = case_when(
  weekend_and_holiday %in% c("weekend", "weekend and holiday", "Weekend", "weekend and holiday") ~ "Weekend", TRUE ~ "Weekday"),
  user_type = member_casual
)
```

# 2. Daily Aggregates 每日骑行汇总

```{r}
daily <- bike %>%
  group_by(start_date) %>%
  summarise(
    total_rides = n(),
    avg_duration = mean(ride_duration_hours, na.rm = TRUE),
    member_rides = sum(member_casual == "member"),
    casual_rides = sum(member_casual == "casual"),
    tmax = tmax,
    prcp = prcp
  )

head(daily)
```

# 3. Daily Ride Volume 骑行量随时间变化

```{r}
p_daily_rides <- ggplot(daily, aes(x = start_date, y = total_rides)) +
  geom_line(size = 1) +
  labs(title = "Daily Ride Volume — September 2025",
       x = "Date", y = "Ride Count") +
  theme_minimal()

p_daily_rides
```

# 4. Member vs Casual ride duration 这个图不大好

## 4.1 Daily average duration

```{r}
dur_ts <- bike %>%
  group_by(start_date, member_casual) %>%
  summarise(mean_duration = mean(ride_duration_hours, na.rm = TRUE))

ggplot(dur_ts, aes(start_date, mean_duration, color = member_casual)) +
  geom_line(size = 1) +
  labs(title = "Daily Average Ride Duration — Member vs Casual",
       x = "Date", y = "Duration (hours)") +
  theme_minimal()
```

## 4.2 Hourly ride count

```{r}
hourly <- bike %>%
  group_by(hour, member_casual, weekend_and_holiday) %>%
  summarise(rides = n())

ggplot(hourly, aes(hour, rides, color = member_casual)) +
  geom_line(size = 1) +
  facet_wrap(~ weekend_and_holiday) +
  labs(title = "Hourly Ride Patterns — Member vs Casual (Weekday vs Weekend)",
       x = "Hour of Day", y = "Ride Count") +
  theme_minimal()
```

## 4.3 Day of week pattern

```{r}
wday_daily <- bike %>%
  group_by(wday, user_type) %>%
  summarise(rides = n(), .groups = "drop") %>%
  mutate(wday = factor(wday, levels = c("Mon","Tue","Wed","Thu","Fri","Sat","Sun")))

p_wday <- ggplot(wday_daily, aes(x = wday, y = rides, fill = user_type)) +
  geom_col(position = "dodge") +
  labs(title = "Ridership by Day of Week (member vs casual)",
       x = "Day of Week", y = "Ride Count", fill = "User Type") +
  theme_minimal()

p_wday

```

As shown in the bar chart, it is clear that member users have much higher ride counts than casual users.

Specifically, member ride counts are particularly high on Mondays and Tuesdays and reach their lowest on weekends. 

In contrast, casual users' ride counts are relatively consistent throughout the week, with slightly higher numbers on weekends. The observation confirms the previous conclusion.


```{r}
p_dur_group <- bike %>%
  group_by(member_casual, weekend_and_holiday) %>%
  summarise(
    mean_duration = mean(ride_duration_hours, na.rm = TRUE)
  ) %>%
  ggplot(aes(x = weekend_and_holiday, y = mean_duration,
             fill = member_casual)) +
  geom_col(position = "dodge") +
  labs(title = "Average Ride Duration — Member vs Casual across Weekday/Weekend",
       x = "Day Type", y = "Duration (hours)") +
  theme_minimal()

p_dur_group
```

# 5. Time series of Average Ride Duration

```{r}
dur_ts <- bike %>%
  group_by(start_date, member_casual) %>%
  summarise(mean_duration = mean(ride_duration_hours, na.rm = TRUE))

p_dur_ts <- ggplot(dur_ts, aes(start_date, mean_duration, color = member_casual)) +
  geom_line(size = 1) +
  labs(title = "Daily Average Ride Duration — Member vs Casual",
       x = "Date", y = "Duration (hours)") +
  theme_minimal()

p_dur_ts
```

# 6. Weather effect

## 6.1 ride count vs temperature level category 这个图说明偏高温人们爱骑车

```{r}
p_temp_level <- bike %>%
  group_by(start_date, temp_level_category) %>%
  summarise(rides = n()) %>%
  ggplot(aes(temp_level_category, rides)) +
  geom_boxplot() +
  labs(title = "Ride Counts by Temperature Level Category",
       x = "Temperature Category", y = "Daily Ride Count") +
  theme_minimal()

p_temp_level
```

## 6.2 ride count vs rain category 这个图小雨在中雨和大雨中间，想办法调一下，除此之外至少能看出来下雨应该与骑行是负相关的

```{r}
p_rain <- bike %>%
  group_by(start_date, rain_category) %>%
  summarise(rides = n()) %>%
  ggplot(aes(rain_category, rides)) +
  geom_boxplot() +
  labs(title = "Ride Counts by Rain Category",
       x = "Rain Category", y = "Daily Ride Count") +
  theme_minimal()

p_rain
```

## 6.3 weather variables

```{r}
# tmax
ggplot(daily, aes(x = tmax, y = total_rides)) +
  geom_point(alpha = .4) +
  geom_smooth(method = "loess") +
  labs(title = "Ride Count vs Daily Maximum Temperature",
       x = "tmax", y = "Rides") +
  theme_minimal()

# prcp
ggplot(daily, aes(x = prcp, y = total_rides)) +
  geom_point(alpha = .4) +
  geom_smooth(method = "loess") +
  labs(title = "Ride Count vs Precipitation",
       x = "Precipitation (mm)", y = "Rides") +
  theme_minimal()
```

# 7 bike type

```{r}
p_type <- bike %>%
  group_by(start_date, rideable_type) %>%
  summarise(rides = n()) %>%
  ggplot(aes(rideable_type, rides)) +
  geom_boxplot() +
  labs(title = "Ride Duration by Bike Type",
       x = "Bike Type", y = "Ride Counts") +
  theme_minimal()

p_type
```


# 7 TSA 尝试做了下时间序列

```{r}
library(tseries)
daily_rides <- bike %>%
  group_by(start_date) %>%
  summarise(total_rides = n(), .groups = "drop")

library(tsibble)
library(fable)

ts_data <- daily_rides %>%
  as_tsibble(index = start_date)

autoplot(ts_data, total_rides) +
  labs(title = "Daily Ride Counts",
       x = "Date",
       y = "Number of Rides")

```

```{r}
fit_arima <- ts_data %>%
  model(ARIMA(total_rides))

report(fit_arima)

```

```{r}
fc <- fit_arima %>% forecast(h = 7)

autoplot(fc, ts_data) +
  labs(title = "ARIMA Forecast of Daily Rides",
       x = "Date",
       y = "Number of Rides")

```

## 7.1 Decomposition 数据分解

```{r}
fit_ets <- ts_data %>% model(ETS(total_rides))

components_plot <- autoplot(components(fit_ets)) +
  labs(
    title = "ETS Decomposition of Daily Ride Counts",
    subtitle = "Using Exponential Smoothing (suitable for short, non-periodic series)",
    x = "Date",
    y = "Value"
  ) +
  theme_minimal()

components_plot

```

# 8 Summary

- Member and casual riders display distinct **daily and weekend/weekday patterns**.  
- Daily ride volume shows clear **temporal trends** across September.  
- Temperature and rainfall strongly shape both **trip volume**.  
- Time-series decomposition reveals trend + seasonality suitable for forecasting. 



